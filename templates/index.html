<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Planner & Logger</title>
    <meta name="description" content="AI-powered daily planning and logging tool">
    <link rel="stylesheet" href="/static/index.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                üìÖ Daily Planner
            </a>
            <nav class="nav">
                <a href="/" class="nav-link active">Dashboard</a>
                <a href="/plan" class="nav-link">Plan</a>
                <a href="/tasks" class="nav-link">Tasks</a>
                <a href="/todos" class="nav-link">To-Dos</a>
                <a href="/history" class="nav-link">History</a>
                <a href="/feedback" class="nav-link">Feedback</a>
                <a href="/summary" class="nav-link">Summary</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Welcome Banner -->
        <div class="card card-glass fade-in" style="margin-bottom: var(--space-lg);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
                <div>
                    <h1 id="greeting">Good morning!</h1>
                    <p id="date-display" style="color: var(--text-secondary);"></p>
                </div>
                <div id="streak-container"></div>
            </div>

            <!-- Today's Progress -->
            <div id="today-stats" style="margin-top: var(--space-lg);">
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-value" id="completed-count">0</span>
                        <span class="stat-label">Completed</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="total-count">0</span>
                        <span class="stat-label">Total Tasks</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="progress-percent">0%</span>
                        <span class="stat-label">Progress</span>
                    </div>
                </div>
                <div class="progress-bar" style="margin-top: var(--space-md);">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <!-- Workflow Alert -->
        <div id="workflow-alert" class="alert alert-warning fade-in" style="display: none;">
            <span>‚ö†Ô∏è</span>
            <span id="workflow-message">Please complete yesterday's summary before planning today.</span>
        </div>

        <!-- Quick Actions -->
        <div class="card fade-in" style="margin-bottom: var(--space-lg);">
            <div class="card-header">
                <h2 class="card-title">‚ö° Quick Actions</h2>
            </div>
            <div class="actions-grid">
                <a href="/plan" class="action-card" id="action-plan">
                    <div class="action-icon">üåÖ</div>
                    <div class="action-title">Plan My Day</div>
                </a>
                <a href="/tasks" class="action-card">
                    <div class="action-icon">‚úÖ</div>
                    <div class="action-title">Check Tasks</div>
                </a>
                <a href="/summary" class="action-card">
                    <div class="action-icon">üåô</div>
                    <div class="action-title">Summarize Day</div>
                </a>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- Contribution Calendar -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">üìä Activity</h2>
                    <span id="calendar-range" style="color: var(--text-muted); font-size: 0.875rem;"></span>
                </div>
                <div class="calendar-container">
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar generated by JS -->
                    </div>
                </div>
                <div class="calendar-legend">
                    <span>Less</span>
                    <div class="legend-box" style="background: var(--contrib-0);"></div>
                    <div class="legend-box" style="background: var(--contrib-1);"></div>
                    <div class="legend-box" style="background: var(--contrib-2);"></div>
                    <div class="legend-box" style="background: var(--contrib-3);"></div>
                    <div class="legend-box" style="background: var(--contrib-4);"></div>
                    <span>More</span>
                </div>
            </div>

            <!-- Today's Tasks Preview -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">üìã Today's Tasks</h2>
                    <a href="/tasks" class="btn btn-secondary" style="font-size: 0.75rem;">View All</a>
                </div>
                <ul class="task-list" id="task-list">
                    <!-- Tasks populated by JS -->
                </ul>
                <div id="no-tasks-message"
                    style="display: none; text-align: center; padding: var(--space-lg); color: var(--text-muted);">
                    <p>No tasks yet.</p>
                    <a href="/plan" class="btn btn-primary" style="margin-top: var(--space-md);">Create Plan</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // State
        let todayData = null;
        let calendarData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            updateGreeting();
            await loadTodayData();
            await loadCalendar();
        });

        // Update greeting based on time
        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingEl = document.getElementById('greeting');
            const dateEl = document.getElementById('date-display');

            if (hour < 12) {
                greetingEl.textContent = 'üåÖ Good morning!';
            } else if (hour < 17) {
                greetingEl.textContent = '‚òÄÔ∏è Good afternoon!';
            } else {
                greetingEl.textContent = 'üåô Good evening!';
            }

            const now = new Date();
            dateEl.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) + ' ‚Ä¢ ' + now.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit'
            });
        }

        // Load today's data
        async function loadTodayData() {
            try {
                const response = await fetch('/api/today');
                todayData = await response.json();

                // Update stats
                const stats = todayData.stats || { completed: 0, total: 0 };
                document.getElementById('completed-count').textContent = stats.completed;
                document.getElementById('total-count').textContent = stats.total;

                const percent = stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0;
                document.getElementById('progress-percent').textContent = percent + '%';
                document.getElementById('progress-fill').style.width = percent + '%';

                // Update streak
                if (todayData.streak > 0) {
                    const streakContainer = document.getElementById('streak-container');
                    const emoji = todayData.streak >= 7 ? 'üî•' : '‚≠ê';
                    streakContainer.innerHTML = `<span class="streak-badge">${emoji} ${todayData.streak} day streak</span>`;
                }

                // Check workflow status
                if (!todayData.workflow.can_plan) {
                    document.getElementById('workflow-alert').style.display = 'flex';
                    document.getElementById('workflow-message').textContent = todayData.workflow.message;
                    document.getElementById('action-plan').classList.add('disabled');
                }

                // Update tasks
                updateTaskList(todayData.plan);

            } catch (error) {
                console.error('Error loading today data:', error);
                showToast('Failed to load data', 'error');
            }
        }

        // Update task list
        function updateTaskList(plan) {
            const taskList = document.getElementById('task-list');
            const noTasksMsg = document.getElementById('no-tasks-message');

            if (!plan || !plan.jobs || plan.jobs.length === 0) {
                taskList.style.display = 'none';
                noTasksMsg.style.display = 'block';
                return;
            }

            taskList.style.display = 'block';
            noTasksMsg.style.display = 'none';

            // Show first 5 tasks
            const tasks = plan.jobs.slice(0, 5);
            const completionStatus = plan.completion_status || {};

            taskList.innerHTML = tasks.map((job, idx) => {
                const status = completionStatus[idx] || 'pending';
                const isCompleted = status === 'done';
                const badgeClass = status === 'done' ? 'badge-done' :
                    status === 'quit' ? 'badge-quit' : 'badge-pending';

                return `
                    <li class="task-item ${isCompleted ? 'completed' : ''}">
                        <input type="checkbox" class="task-checkbox" 
                               ${isCompleted ? 'checked' : ''} 
                               data-index="${idx}"
                               onclick="toggleTask(${idx})">
                        <div class="task-content">
                            <div class="task-name">${escapeHtml(job.name)}</div>
                            <div class="task-description">${escapeHtml(job.user_input || job.description || '')}</div>
                        </div>
                        <span class="task-badge ${badgeClass}">${status}</span>
                    </li>
                `;
            }).join('');

            if (plan.jobs.length > 5) {
                taskList.innerHTML += `
                    <li class="task-item" style="justify-content: center;">
                        <a href="/tasks" style="color: var(--accent-cyan);">
                            View ${plan.jobs.length - 5} more tasks ‚Üí
                        </a>
                    </li>
                `;
            }
        }

        // Toggle task completion
        async function toggleTask(index) {
            try {
                const currentStatus = todayData.plan?.completion_status?.[index] || 'pending';
                const newStatus = currentStatus === 'done' ? 'pending' : 'done';

                const response = await fetch('/api/task/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ job_index: index, status: newStatus })
                });

                if (response.ok) {
                    showToast(newStatus === 'done' ? '‚úÖ Task completed!' : 'Task marked pending');
                    await loadTodayData();
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                showToast('Failed to update task', 'error');
            }
        }

        // Load contribution calendar
        async function loadCalendar() {
            try {
                const response = await fetch('/api/calendar?weeks=16');
                calendarData = await response.json();
                renderCalendar(calendarData.contributions);
            } catch (error) {
                console.error('Error loading calendar:', error);
            }
        }

        // Render calendar
        function renderCalendar(contributions) {
            const grid = document.getElementById('calendar-grid');
            const rangeEl = document.getElementById('calendar-range');

            const today = new Date();
            const endDate = new Date(today);
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - (16 * 7));

            // Align to Sunday
            startDate.setDate(startDate.getDate() - startDate.getDay());

            rangeEl.textContent = `${startDate.toLocaleDateString('en-US', { month: 'short' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`;

            let html = '';
            let currentDate = new Date(startDate);

            for (let week = 0; week < 16; week++) {
                html += '<div class="calendar-week">';

                for (let day = 0; day < 7; day++) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    const data = contributions[dateStr] || { completed: 0, total: 0 };

                    let level = 0;
                    if (data.total > 0) {
                        const ratio = data.completed / data.total;
                        if (ratio > 0) level = 1;
                        if (ratio >= 0.25) level = 2;
                        if (ratio >= 0.5) level = 3;
                        if (ratio >= 0.75) level = 4;
                    }

                    const isToday = dateStr === today.toISOString().split('T')[0];
                    const isFuture = currentDate > today;

                    if (isFuture) {
                        html += `<div class="calendar-day" style="opacity: 0.3;"></div>`;
                    } else {
                        html += `<div class="calendar-day ${isToday ? 'today' : ''}" 
                                     data-level="${level}" 
                                     title="${dateStr}: ${data.completed}/${data.total} tasks">
                                 </div>`;
                    }

                    currentDate.setDate(currentDate.getDate() + 1);
                }

                html += '</div>';
            }

            grid.innerHTML = html;
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
    </script>
</body>

</html>