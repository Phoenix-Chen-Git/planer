<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goals - Daily Planner</title>
    <link rel="stylesheet" href="/static/index.css">
    <style>
        .goal-tree {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .goal-node {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .goal-node.expanded>.sub-goals-container {
            display: block;
        }

        .goal-header {
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            cursor: pointer;
        }

        .goal-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .goal-expand-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .goal-node.expanded>.goal-header .goal-expand-btn {
            transform: rotate(90deg);
        }

        .goal-node.leaf>.goal-header .goal-expand-btn {
            visibility: hidden;
        }

        .goal-content {
            flex: 1;
        }

        .goal-title-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .goal-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .goal-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .goal-progress-container {
            margin-top: 0.5rem;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            color: var(--text-secondary);
        }

        .progress-track {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-hover) 100%);
            transition: width 0.5s ease;
        }

        .goal-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .goal-node:hover>.goal-header .goal-actions {
            opacity: 1;
        }

        .sub-goals-container {
            display: none;
            padding: 0 0 0 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.1);
        }

        .sub-goal-node {
            border-top: 1px solid var(--border);
        }

        .sub-goal-node:first-child {
            border-top: none;
        }

        /* Status Colors */
        .status-completed .goal-title {
            text-decoration: line-through;
            opacity: 0.7;
        }

        .status-completed .progress-fill {
            background: var(--success);
        }

        /* Priority Colors */
        .priority-high {
            color: #f85149;
        }

        .priority-medium {
            color: #d29922;
        }

        .priority-low {
            color: #3fb950;
        }

        /* Add Goal Modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">üìÖ Daily Planner</a>
            <nav class="nav">
                <a href="/" class="nav-link">Dashboard</a>
                <a href="/plan" class="nav-link">Plan</a>
                <a href="/tasks" class="nav-link">Tasks</a>

                <a href="/goals" class="nav-link active">Goals</a>
                <a href="/radar" class="nav-link">Radar</a>
                <a href="/history" class="nav-link">History</a>
                <a href="/feedback" class="nav-link">Feedback</a>
                <a href="/summary" class="nav-link">Summary</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card"
            style="margin-bottom: var(--space-lg); display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>üéØ Goals & Tasks</h1>
                <p style="color: var(--text-secondary);">Track long-term goals, projects, and daily tasks</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <div class="view-toggle">
                    <button class="btn btn-secondary active" onclick="setFilter('all')">All</button>
                    <button class="btn btn-secondary" onclick="setFilter('goals')">Goals</button>
                    <button class="btn btn-secondary" onclick="setFilter('tasks')">Tasks</button>
                </div>
                <button class="btn btn-primary" onclick="openAddGoalModal()">‚ûï New Goal/Task</button>
            </div>
        </div>

        <div id="goals-container" class="goal-tree">
            <!-- Goals populated by JS -->
        </div>

        <div id="loading" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            Loading goals...
        </div>

        <div id="empty-state" style="display: none; text-align: center; padding: 3rem; color: var(--text-muted);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üéØ</div>
            <p>No goals set yet. Start by adding a top-level goal!</p>
        </div>
    </main>

    <!-- Add/Edit Goal Modal -->
    <div id="goal-modal" class="modal">
        <div class="modal-content fade-in">
            <h2 id="modal-title" style="margin-top: 0;">Add New Goal</h2>
            <form id="goal-form" onsubmit="handleGoalSubmit(event)">
                <input type="hidden" id="parent-id">
                <input type="hidden" id="edit-goal-id">

                <div class="form-group">
                    <label for="goal-name">Goal Name</label>
                    <input type="text" id="goal-name" class="form-control" placeholder="e.g. Master Python Programming"
                        required>
                </div>

                <div class="form-group" id="type-group">
                    <label for="goal-type">Type</label>
                    <select id="goal-type" class="form-control">
                        <option value="task">‚úÖ Task (Short-term)</option>
                        <option value="long_term">üéØ Long-term (1+ year)</option>
                        <option value="yearly">üìÖ Yearly</option>
                        <option value="monthly">üìÜ Monthly</option>
                        <option value="weekly">üìã Weekly</option>
                    </select>
                </div>

                <div class="form-group" id="priority-group">
                    <label for="goal-priority">Priority</label>
                    <select id="goal-priority" class="form-control">
                        <option value="high">üî¥ High</option>
                        <option value="medium" selected>üü° Medium</option>
                        <option value="low">üü¢ Low</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="goal-deadline">Deadline (Optional)</label>
                    <input type="date" id="goal-deadline" class="form-control">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Goal</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
        let allGoals = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            loadGoals();
        });

        async function loadGoals() {
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await fetch('/api/goals');
                const data = await response.json();
                allGoals = data.goals || [];
                renderGoals();
            } catch (error) {
                showToast('Failed to load goals: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderGoals() {
            const container = document.getElementById('goals-container');
            const emptyState = document.getElementById('empty-state');

            container.innerHTML = '';

            // Filter goals
            let filtered = allGoals;
            if (currentFilter === 'goals') {
                filtered = allGoals.filter(g => g.type !== 'task');
            } else if (currentFilter === 'tasks') {
                filtered = allGoals.filter(g => g.type === 'task');
            }

            if (filtered.length === 0) {
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Sort goals by priority then deadline
            const sortedGoals = sortGoals(filtered);

            sortedGoals.forEach(goal => {
                container.appendChild(createGoalNode(goal));
            });
        }

        function setFilter(filter) {
            currentFilter = filter;

            // Update buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                if (btn.textContent.toLowerCase() === filter) {
                    btn.classList.add('active');
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                }
            });

            renderGoals();
        }

        function sortGoals(goals) {
            const priorityMap = { 'high': 0, 'medium': 1, 'low': 2 };
            return [...goals].sort((a, b) => {
                // Priority first
                const pA = priorityMap[a.priority || 'low'];
                const pB = priorityMap[b.priority || 'low'];
                if (pA !== pB) return pA - pB;

                // Then deadline (earliest first) - nulls last
                if (!a.deadline) return 1;
                if (!b.deadline) return -1;
                return new Date(a.deadline) - new Date(b.deadline);
            });
        }

        function createGoalNode(goal, level = 0) {
            const hasSubGoals = goal.sub_goals && goal.sub_goals.length > 0;
            const node = document.createElement('div');
            node.className = `goal-node ${hasSubGoals ? 'expanded' : 'leaf'} status-${goal.status}`;
            if (level > 0) node.className += ' sub-goal-node';

            // Progress Calculation
            const progress = goal.time_progress || 0;
            let progressColor = 'var(--primary)';
            if (progress > 90) progressColor = '#f85149'; // Warning near deadline
            else if (progress > 100) progressColor = '#f85149'; // Overdue
            else if (goal.status === 'completed') progressColor = 'var(--success)';

            const daysRemaining = goal.days_remaining;
            let deadlineText = '';

            if (goal.deadline) {
                const d = new Date(goal.deadline);
                deadlineText = `üìÖ Deadline: ${d.toLocaleDateString()}`;
                if (daysRemaining !== null) {
                    if (daysRemaining < 0) deadlineText += ` <span style="color: #f85149;">(${Math.abs(daysRemaining)} days overdue)</span>`;
                    else if (daysRemaining === 0) deadlineText += ` <span style="color: #d29922;">(Due today)</span>`;
                    else deadlineText += ` <span style="opacity: 0.8;">(${daysRemaining} days left)</span>`;
                }
            } else {
                deadlineText = `<span style="opacity: 0.5;">No deadline set</span>`;
            }

            const priorityIcon = {
                'high': 'üî¥',
                'medium': 'üü°',
                'low': 'üü¢'
            }[goal.priority || 'medium'] || '‚ö™';

            node.innerHTML = `
                <div class="goal-header" onclick="toggleExpand(this)">
                    <button class="goal-expand-btn" onclick="event.stopPropagation(); toggleExpand(this.parentElement)">
                        ${hasSubGoals ? '‚ñ∂' : '‚Ä¢'}
                    </button>
                    
                    <div class="goal-content">
                        <div class="goal-title-row">
                            <span title="Priority: ${goal.priority}">${priorityIcon}</span>
                            <span class="goal-title">${escapeHtml(goal.name)}</span>
                            ${goal.status === 'completed' ? '<span class="badge badge-done" style="font-size: 0.7em;">COMPLETED</span>' : ''}
                        </div>
                        
                        <div class="goal-meta">
                            ${level === 0 ? `<div class="meta-item"><span style="text-transform: capitalize;">${escapeHtml(goal.type?.replace('_', ' ') || 'Goal')}</span></div>` : ''}
                            <div class="meta-item">${deadlineText}</div>
                        </div>
                        
                        ${goal.deadline ? `
                        <div class="goal-progress-container">
                            <div class="progress-label">
                                <span>Time Elapsed</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${Math.min(progress, 100)}%; background: ${progressColor};"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="goal-actions" onclick="event.stopPropagation()">
                        ${level < 2 ? `<button class="btn btn-secondary btn-sm needs-click" onclick="openAddSubGoalModal('${goal.id}', '${escapeHtml(goal.name)}')">‚ûï Sub</button>` : ''}
                        <button class="btn btn-secondary btn-sm needs-click" onclick="openEditGoal('${goal.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-secondary btn-sm needs-click" onclick="toggleStatus('${goal.id}', '${goal.status}')">
                            ${goal.status === 'completed' ? '‚Ü©Ô∏è' : '‚úÖ'}
                        </button>
                        <button class="btn btn-secondary btn-sm needs-click" style="color: #f85149;" onclick="deleteGoal('${goal.id}')">üóëÔ∏è</button>
                    </div>
                </div>
                
                <div class="sub-goals-container">
                    <!-- Sub-goals rendered here -->
                </div>
            `;

            if (hasSubGoals) {
                const subContainer = node.querySelector('.sub-goals-container');
                // Sort sub-goals
                const subGoals = [...goal.sub_goals].sort((a, b) => {
                    if (!a.deadline) return 1;
                    if (!b.deadline) return -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });

                subGoals.forEach(sub => {
                    subContainer.appendChild(createGoalNode(sub, level + 1));
                });
            }

            return node;
        }

        function toggleExpand(element) {
            // Find the goal-node parent
            const node = element.closest('.goal-node');
            if (node.classList.contains('leaf')) return;

            node.classList.toggle('expanded');
        }

        // --- Modal & Form Handling ---

        function openAddGoalModal() {
            document.getElementById('modal-title').textContent = 'Add New Goal/Task';
            document.getElementById('goal-form').reset();
            document.getElementById('parent-id').value = '';
            document.getElementById('edit-goal-id').value = '';

            document.getElementById('type-group').style.display = 'block';
            document.getElementById('priority-group').style.display = 'block';

            document.getElementById('goal-modal').classList.add('active');
        }

        function openAddSubGoalModal(parentId, parentName) {
            document.getElementById('modal-title').textContent = `Add Sub-Goal to "${parentName}"`;
            document.getElementById('goal-form').reset();
            document.getElementById('parent-id').value = parentId;
            document.getElementById('edit-goal-id').value = '';

            // Sub-goals inherit context, don't show type/priority inputs to simplify
            // (You could enable them if desired, but typically sub-goals are just tasks)
            document.getElementById('type-group').style.display = 'none';
            document.getElementById('priority-group').style.display = 'none';

            document.getElementById('goal-modal').classList.add('active');
        }

        function openEditGoal(goalId) {
            // Find goal in tree
            const goal = findGoal(allGoals, goalId);
            if (!goal) return;

            document.getElementById('modal-title').textContent = 'Edit Goal';
            document.getElementById('goal-name').value = goal.name;
            document.getElementById('goal-deadline').value = goal.deadline || '';
            document.getElementById('edit-goal-id').value = goalId;
            document.getElementById('parent-id').value = ''; // Not used for edits

            const isTopLevel = !goalId.includes('.');
            document.getElementById('type-group').style.display = isTopLevel ? 'block' : 'none';
            document.getElementById('priority-group').style.display = isTopLevel ? 'block' : 'none';

            if (isTopLevel) {
                document.getElementById('goal-type').value = goal.type || 'long_term';
                document.getElementById('goal-priority').value = goal.priority || 'medium';
            }

            document.getElementById('goal-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('goal-modal').classList.remove('active');
        }

        async function handleGoalSubmit(e) {
            e.preventDefault();

            const name = document.getElementById('goal-name').value;
            const deadline = document.getElementById('goal-deadline').value || null;
            const parentId = document.getElementById('parent-id').value;
            const editId = document.getElementById('edit-goal-id').value;

            const type = document.getElementById('goal-type').value;
            const priority = document.getElementById('goal-priority').value;

            try {
                let url, method, body;

                if (editId) {
                    // Edit existing
                    url = `/api/goals/${editId}`;
                    method = 'PUT';
                    body = { name, deadline, type, priority };
                } else if (parentId) {
                    // Create sub-goal
                    url = `/api/goals/${parentId}/subgoals`;
                    method = 'POST';
                    body = { name, deadline };
                } else {
                    // Create top-level
                    url = '/api/goals';
                    method = 'POST';
                    body = { name, deadline, type, priority };
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (data.success) {
                    closeModal();
                    showToast('Goal saved successfully!');
                    loadGoals();
                } else {
                    showToast(data.error || 'Failed to save goal', 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function deleteGoal(id) {
            if (!confirm('Are you sure you want to delete this goal and all its sub-goals?')) return;

            try {
                const res = await fetch(`/api/goals/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast('Goal deleted');
                    loadGoals();
                } else {
                    showToast('Failed to delete', 'error');
                }
            } catch (error) {
                showToast('Error deleting goal', 'error');
            }
        }

        async function toggleStatus(id, currentStatus) {
            const newStatus = currentStatus === 'completed' ? 'active' : 'completed';
            try {
                const res = await fetch(`/api/goals/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (res.ok) {
                    showToast(newStatus === 'completed' ? 'Goal completed! üéâ' : 'Goal reactivated');
                    loadGoals();
                }
            } catch (error) {
                showToast('Error updating status', 'error');
            }
        }

        // --- Helpers ---

        function findGoal(goals, id) {
            for (let g of goals) {
                if (String(g.id) === String(id)) return g;
                if (g.sub_goals) {
                    const found = findGoal(g.sub_goals, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            if (type === 'error') toast.style.borderLeftColor = '#f85149';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Close modal on outside click
        window.onclick = function (event) {
            const modal = document.getElementById('goal-modal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>

</html>